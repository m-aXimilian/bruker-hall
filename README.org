#+startup: indent
#+title: Bruker Hall measurements
#+subtitle: using fmr-py as submodule

* Description
Controlled ramping of a B-field function and measuring
Lockin-Amplifier parameters. Can be used for *Hall-effect* and *MR*
measurements.

** H-Field Ramp
The waveform for the ramp is generated automatically by means of the
parameters (start, stop, increment, etc.) in [[file:config/measurement.yaml][measurement config]] file.
Based on this wave 2 set-values are generated for
1. the xantrex power supply and
2. the PID-controller.
The first is taken from a fit-function (see figure [[fit-fuctions]]) based
on B-field measurements for different power supply voltages.

#+BEGIN_QUOTE
The fit-function is generated from the data provided in ``B-field-lookup.yaml''. The order of the fit-function can be passed by setting the ~deg~ parameter.
If not provided, a fit of the first order is calculated.
#+END_QUOTE

#+name: fit-fuctions
#+html: <p align="center"><img src="doc/field-set-functions_many-points.png" width="60%"></p>
The PID-controller value is just a scaled value based on the ramp
wave.
See figure [[ramp-set]]  for an example for a triangular shaped ramp from 0 to 1T
#+name: ramp-set
#+html: <p align="center"><img src="doc/field-set-voltages_0-1T-ramp_many-points.png" width="60%"></p>

** Bruker time-constant
Needed to prevent runaways of the is value that must be compensated by the PID-controller and result in (too) high currents.
This happens when the set values are increased too fast for the Bruker magnet to follow (main coil). 
The time-constant describes the time it takes the main coil to reach a new set value. It is calculated in s/mT and can be scaled 
by the respective step size of a measurement. The scaled value should be awaited between subsequent set values.
A time-constant of *0.8s/mT* follows from a field-ramp measurement form 0 to 600mT in 2mT steps.

#+BEGIN_QUOTE
The time-constant was calculated by ramping the B-field with the xantrex power supply only. It is assumed that a new set value 
is reached when two subsequent (200ms apart from one another) B-field measurements differ by less than 0.1mT. This time was recorded and taken as a basis for 
the calculation.
#+END_QUOTE

#+name: bruker-time-const
#+html: <p align="center"><img src="doc/bruker_time-constant.png" width="60%"></p>


** Measurement
The SR8320 sources a sinus voltage, which generates a ``constant''
current by means of a high resistance (kÎ©). The input is locked in at
the source frequency. For every value in of the waveform array
- the respective B-field is set,
- the process waits until the B-field is within the boundary
  ``delta-start'' configured in [[file:config/measurement.yaml][measurement config]]
- a number of N measurements is recorded and written to a file

* Usage
  #+begin_src sh
  git clone --recurse-submodules https://gitlab.lrz.de/m-aximilian/bruker-hall.git
  cd bruker-hall
  #+end_src

** Run with UI 
The devices from the [[file:config/devices.yaml][devices config]] must be attached and known to the system.
Run the ~main.py~ file. This will instantiate the following UI
#+name: ui-screenshot
#+html: <p align="center"><img src="doc/UI-screenshot_windows.png" width="60%"></p>
There are 3 possibilites to start a measurement:
1. configure nothing and hit ``Start Measurement''
  This will take the default [[file:config/measurement.yaml][measurement config]] and save the results at ~./results~
2. configure within the UI and hit ``Save Configuration''
  This will execute a measurement according to the provided parameters and save the data to wherever the ~path~ in the /Data/-Tab is pointing to.
3. load an existing configuration with ``Load Configuration''
  This will execute a measurement based on the provided configuration file

Note that every measurement will be put in it own folder. The name of which is an autogenerated uuid. The data gets the same uuid with a ``data_'' prefix. 
Configuration gets a ``config_'' prefix. 


* Notes and Parameters

** Parameters
- Hall Sensor: 1V := 100mT
- Xantrex voltage range: 0-150V
  
* Hardware
- 2T Bruker Magnet
- [[https://www.manualslib.com/manual/633965/Xantrex-Xfr-6-200.html#product-XFR%20150-8][xantrex XFR 150-8]]
- [[https://www.thinksrs.com/downloads/pdfs/manuals/SR830m.pdf][Stanford Research SR830 Lockin Amplifier]]
- Audio Amplifier with PID-controller




